#!/bin/bash
# agent-run - Agent 글로벌 실행 진입점
# 모든 프로젝트의 표준 실행 방법
#
# 사용법:
#   agent-run --project <name> [options]
#   agent-run --list                     # 프로젝트 목록
#   agent-run --help                     # 도움말
#
# 옵션:
#   --project=NAME, -p NAME   프로젝트 이름
#   --flow=FILE               flow.yaml 파일 경로
#   --step=STEP_ID            특정 스텝만 실행
#   --section=SECTION_ID      특정 섹션만 실행
#   --var KEY=VALUE           변수 오버라이드
#   --run-id=ID               실행 ID 지정
#   --dry-run                 실제 실행 없이 검증만
#   --resume=RUN_ID           이전 실행 재개
#   --list                    프로젝트 목록
#   --info                    프로젝트 정보
#   --help, -h                도움말

set -e

# ══════════════════════════════════════════════════════════════
# 경로 설정
# ══════════════════════════════════════════════════════════════

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENT_ROOT="$(dirname "$SCRIPT_DIR")"
CORE_DIR="${AGENT_ROOT}/core"
PROJECTS_DIR="${AGENT_ROOT}/projects"

# ══════════════════════════════════════════════════════════════
# Core 모듈 로드
# ══════════════════════════════════════════════════════════════

# Runtime
source "${CORE_DIR}/runtime/context.sh"
source "${CORE_DIR}/runtime/artifact.sh"
source "${CORE_DIR}/runtime/override.sh"

# LLM
source "${CORE_DIR}/llm/router.sh"

# Engine
source "${CORE_DIR}/flow_runner.sh" 2>/dev/null || true
source "${CORE_DIR}/prompt_engine.sh" 2>/dev/null || true

# Util
source "${CORE_DIR}/util/sections_loader.sh" 2>/dev/null || true

# Common (레거시)
source "${AGENT_ROOT}/common/chatgpt.sh" 2>/dev/null || true
source "${AGENT_ROOT}/common/state.sh" 2>/dev/null || true

# ══════════════════════════════════════════════════════════════
# 로깅
# ══════════════════════════════════════════════════════════════

log_info() {
    echo "[INFO] $*" >&2
}

log_warn() {
    echo "[WARN] $*" >&2
}

log_error() {
    echo "[ERROR] $*" >&2
}

log_debug() {
    if [[ "$DEBUG" == "true" ]]; then
        echo "[DEBUG] $*" >&2
    fi
}

# ══════════════════════════════════════════════════════════════
# 도움말
# ══════════════════════════════════════════════════════════════

show_help() {
    cat <<'HELP'
Agent Runner - 프로젝트 실행 도구

사용법:
  agent-run --project <name> [options]
  agent-run --list
  agent-run --help

프로젝트 실행:
  agent-run -p ai_court_auction
  agent-run --project=ai_court_auction --step=write
  agent-run -p my_project --var topic="AI 서비스"

옵션:
  -p, --project=NAME     프로젝트 이름 (필수)
  --flow=FILE            flow.yaml 파일 경로 (기본: flow.yaml)
  --step=STEP_ID         특정 스텝만 실행
  --section=SECTION_ID   특정 섹션만 실행
  --var KEY=VALUE        변수 오버라이드 (여러 개 가능)
  --run-id=ID            실행 ID 지정 (기본: 타임스탬프)
  --dry-run              실제 실행 없이 검증만
  --resume=RUN_ID        이전 실행 재개

조회:
  --list                 프로젝트 목록
  --info                 프로젝트 정보 (--project 필요)
  --status               현재 상태

기타:
  --debug                디버그 모드
  -h, --help             도움말

예시:
  # 프로젝트 실행
  agent-run -p ai_court_auction

  # 특정 섹션만 실행
  agent-run -p ai_court_auction --section=s1_2

  # 변수 오버라이드
  agent-run -p ai_court_auction --var topic="AI 법원 경매"

  # Dry run
  agent-run -p ai_court_auction --dry-run

환경변수:
  AGENT_VAR_*            변수 오버라이드 (예: AGENT_VAR_TOPIC="...")
  DEBUG=true             디버그 모드
  ANTHROPIC_API_KEY      Claude API 키

HELP
}

# ══════════════════════════════════════════════════════════════
# 프로젝트 목록
# ══════════════════════════════════════════════════════════════

list_projects() {
    echo "Available Projects:"
    echo "═══════════════════════════════════════════"
    echo ""

    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -d "$dir" ]]; then
            local name=$(basename "$dir")
            local has_flow=""
            local has_sections=""
            local has_config=""

            [[ -f "${dir}/flow.yaml" ]] && has_flow="flow"
            [[ -f "${dir}/sections.yaml" ]] && has_sections="sections"
            [[ -f "${dir}/config.yaml" ]] && has_config="config"

            printf "  %-25s [%s %s %s]\n" "$name" "$has_flow" "$has_sections" "$has_config"
        fi
    done

    echo ""
    echo "Usage: agent-run --project <name>"
}

# ══════════════════════════════════════════════════════════════
# 프로젝트 정보
# ══════════════════════════════════════════════════════════════

show_project_info() {
    local project_name="$1"
    local project_dir="${PROJECTS_DIR}/${project_name}"

    if [[ ! -d "$project_dir" ]]; then
        log_error "Project not found: $project_name"
        return 1
    fi

    echo "Project: $project_name"
    echo "═══════════════════════════════════════════"
    echo ""
    echo "Path: $project_dir"
    echo ""

    # Flow 정보
    if [[ -f "${project_dir}/flow.yaml" ]]; then
        echo "[Flow]"
        python3 -c "
import yaml
with open('${project_dir}/flow.yaml', 'r') as f:
    data = yaml.safe_load(f)
print(f\"  Name: {data.get('name', 'N/A')}\")
print(f\"  Version: {data.get('version', 'N/A')}\")
steps = data.get('steps', [])
print(f\"  Steps: {len(steps)}\")
" 2>/dev/null
        echo ""
    fi

    # Sections 정보
    if [[ -f "${project_dir}/sections.yaml" ]]; then
        echo "[Sections]"
        python3 -c "
import yaml
with open('${project_dir}/sections.yaml', 'r') as f:
    data = yaml.safe_load(f)
sections = data.get('sections', [])
print(f\"  Total: {len(sections)} sections\")
total_pages = sum(s.get('pages', 1) for s in sections)
print(f\"  Pages: {total_pages:.1f}\")
" 2>/dev/null
        echo ""
    fi

    # 최근 실행
    local runs_dir="${project_dir}/runs"
    if [[ -d "$runs_dir" ]]; then
        echo "[Recent Runs]"
        ls -1t "$runs_dir" 2>/dev/null | head -5 | while read -r run; do
            echo "  - $run"
        done
        echo ""
    fi
}

# ══════════════════════════════════════════════════════════════
# 메인 실행
# ══════════════════════════════════════════════════════════════

run_project() {
    local project_name="$1"
    shift

    # 컨텍스트 초기화
    log_info "Initializing context: $project_name"
    context_init "$project_name" "$@" || {
        log_error "Failed to initialize context"
        return 1
    }

    # Override 로드
    log_info "Loading overrides..."
    override_load "$@"

    # Sections 로더 초기화
    if [[ -f "${PROJECT_DIR}/sections.yaml" ]]; then
        _sections_init_order 2>/dev/null || true
    fi

    # Flow 파일 확인
    local flow_file="${FLOW_FILE:-${PROJECT_DIR}/flow.yaml}"
    if [[ ! -f "$flow_file" ]]; then
        log_error "Flow file not found: $flow_file"
        return 1
    fi

    export FLOW_FILE="$flow_file"

    # Dry run 모드
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "=== DRY RUN MODE ==="
        echo ""
        context_info
        echo ""
        override_list
        echo ""
        log_info "Flow file: $flow_file"
        log_info "Would execute flow..."
        return 0
    fi

    # 프로젝트별 handler 로드 (있으면)
    local handler="${PROJECT_DIR}/handlers/workflow.sh"
    if [[ -f "$handler" ]]; then
        log_info "Loading project handler: $handler"
        source "$handler"
    fi

    # Flow 실행
    log_info "Starting flow execution..."
    echo ""

    if type flow_run &>/dev/null; then
        flow_run "$@"
    else
        log_warn "flow_run not available, checking for legacy run.sh"

        local legacy_run="${PROJECT_DIR}/run.sh"
        if [[ -f "$legacy_run" ]]; then
            log_info "Executing legacy run.sh"
            bash "$legacy_run" "$@"
        else
            log_error "No execution method available"
            return 1
        fi
    fi

    # 컨텍스트 종료
    context_finalize "completed"

    log_info "Execution completed"
    log_info "Run ID: $RUN_ID"
    log_info "Output: $OUTPUT_DIR"
}

# ══════════════════════════════════════════════════════════════
# 인자 파싱 및 실행
# ══════════════════════════════════════════════════════════════

main() {
    local project_name=""
    local flow_file=""
    local step_id=""
    local section_id=""
    local run_id=""
    local resume_id=""
    local dry_run=false
    local show_list=false
    local show_info=false
    local var_args=()

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p)
                project_name="$2"
                shift 2
                ;;
            --project=*)
                project_name="${1#--project=}"
                shift
                ;;
            --flow=*)
                flow_file="${1#--flow=}"
                shift
                ;;
            --step=*)
                step_id="${1#--step=}"
                shift
                ;;
            --section=*)
                section_id="${1#--section=}"
                shift
                ;;
            --run-id=*)
                run_id="${1#--run-id=}"
                shift
                ;;
            --resume=*)
                resume_id="${1#--resume=}"
                shift
                ;;
            --var=*|--set=*)
                var_args+=("$1")
                shift
                ;;
            --var|--set)
                var_args+=("--var=$2")
                shift 2
                ;;
            --dry-run)
                dry_run=true
                shift
                ;;
            --list)
                show_list=true
                shift
                ;;
            --info)
                show_info=true
                shift
                ;;
            --debug)
                export DEBUG=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                log_warn "Unknown option: $1"
                shift
                ;;
        esac
    done

    # 프로젝트 목록
    if [[ "$show_list" == "true" ]]; then
        list_projects
        exit 0
    fi

    # 프로젝트 정보
    if [[ "$show_info" == "true" ]]; then
        if [[ -z "$project_name" ]]; then
            log_error "Project name required for --info"
            exit 1
        fi
        show_project_info "$project_name"
        exit 0
    fi

    # 프로젝트 필수
    if [[ -z "$project_name" ]]; then
        log_error "Project name required"
        echo ""
        echo "Usage: agent-run --project <name>"
        echo "       agent-run --list"
        exit 1
    fi

    # 환경 변수 설정
    export DRY_RUN="$dry_run"
    [[ -n "$flow_file" ]] && export FLOW_FILE="$flow_file"
    [[ -n "$step_id" ]] && export TARGET_STEP="$step_id"
    [[ -n "$section_id" ]] && export TARGET_SECTION="$section_id"

    # 실행 인자 구성
    local run_args=()
    [[ -n "$run_id" ]] && run_args+=("--run-id=$run_id")
    run_args+=("${var_args[@]}")

    # Resume 모드
    if [[ -n "$resume_id" ]]; then
        log_info "Resuming run: $resume_id"
        run_args+=("--run-id=$resume_id")
        artifact_load_run "$resume_id" 2>/dev/null || true
    fi

    # 실행
    run_project "$project_name" "${run_args[@]}"
}

# 실행
main "$@"
